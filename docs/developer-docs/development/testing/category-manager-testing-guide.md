# 分类管理功能重构 - 测试说明

- 适用版本: `>=1.0.0`
- 文档状态: `active`
- 最后更新: `2026-02-10`

## 快速测试步骤

### 1. 启动应用

```bash
# 激活虚拟环境并运行
.venv\Scripts\Activate.ps1
python run.py --dev
```

### 2. 打开分类管理对话框

1. 进入"模板库"页面
2. 点击"管理分类"按钮

### 3. 测试基础功能

#### 测试新建分类

1. 点击工具栏的"新建"按钮
2. 输入分类名称，例如"测试分类1"
3. 确认后应该立即显示在树中

#### 测试重命名分类

**方法1：使用工具栏按钮**
1. 选中一个分类
2. 点击"重命名"按钮（此时应该是可用状态）
3. 输入新名称
4. 确认后立即更新

**方法2：使用F2快捷键**
1. 选中一个分类
2. 按F2键
3. 输入新名称
4. 确认后立即更新

**方法3：使用右键菜单**
1. 右键点击分类
2. 选择"重命名 (F2)"
3. 输入新名称
4. 确认后立即更新

#### 测试删除分类

**批量删除（使用复选框）**
1. 勾选一个或多个分类的复选框
2. 点击"删除"按钮（此时应该是可用状态）
3. 确认删除对话框
4. 分类立即被删除

**单个删除（使用右键菜单）**
1. 右键点击分类
2. 选择"删除此项"
3. 确认删除对话框
4. 分类立即被删除

#### 测试排序模式

1. 点击"排序"按钮（带SYNC图标）
2. 观察变化：
   - 排序按钮应该高亮显示（按下状态）
   - 复选框应该消失
   - 新建/重命名/删除按钮应该被禁用
   - 拖拽功能应该启用（注意：拖拽验证逻辑尚未完全实现）
3. 再次点击"排序"按钮退出排序模式
4. 观察变化：
   - 排序按钮恢复正常
   - 复选框重新显示
   - 新建按钮恢复可用
   - 应该显示"排序已保存"提示

#### 测试帮助功能

1. 点击"帮助"按钮（INFO图标）
2. 应该显示 TeachingTip 提示框
3. 内容应该包含操作指南
4. 可以关闭提示框

### 4. 验证即时保存

1. 执行任何操作（新建、重命名、删除）
2. 关闭对话框
3. 重新打开对话框
4. 验证更改已经保存

### 5. 边界条件测试

#### 测试系统分类保护

1. 尝试删除"未分类"（系统分类）
2. 应该显示错误提示："系统分类无法删除"

#### 测试重命名唯一性验证

1. 创建两个同级分类："分类A"和"分类B"
2. 尝试将"分类B"重命名为"分类A"
3. 应该显示错误提示："同一层级下已存在名为 '分类A' 的分类"

## 已知问题

### 1. 拖拽排序功能未完全实现

**现状**：
- ✅ 排序模式的UI切换已实现
- ✅ 保存排序到数据库的方法已实现
- ❌ 拖拽事件处理尚未实现
- ❌ 拖拽验证逻辑尚未实现

**影响**：
- 在排序模式下，虽然拖拽功能已启用，但拖拽操作可能不会正确更新分类顺序
- 退出排序模式时会保存当前树的顺序，但如果没有正确处理拖拽事件，顺序可能不会改变

**解决方案**：
需要实现以下方法：
- 重写 `dropEvent` 处理拖拽放置
- 实现 `_validate_drag()` 验证拖拽合法性
- 实现 `_is_descendant()` 检查子孙关系

### 2. 图标替换

由于 QFluentWidgets 没有 `SORT` 图标，已使用 `SYNC` 图标替代。如果需要更合适的图标，可以：
- 使用自定义图标
- 或者查找 QFluentWidgets 中其他合适的图标

## 测试清单

### 基础功能
- [ ] 新建根分类
- [ ] 新建子分类
- [ ] 重命名分类（工具栏按钮）
- [ ] 重命名分类（F2快捷键）
- [ ] 重命名分类（右键菜单）
- [ ] 批量删除分类（复选框）
- [ ] 单个删除分类（右键菜单）
- [ ] 帮助提示显示

### 模式切换
- [ ] 进入排序模式（UI状态正确）
- [ ] 退出排序模式（UI状态正确）
- [ ] 排序模式下编辑按钮被禁用

### 数据持久化
- [ ] 新建分类后立即保存
- [ ] 重命名分类后立即保存
- [ ] 删除分类后立即保存
- [ ] 关闭对话框后重新打开，数据保持

### 边界条件
- [ ] 系统分类无法删除
- [ ] 系统分类无法重命名
- [ ] 同级分类名称唯一性验证
- [ ] 最大深度限制（3层）

### UI交互
- [ ] 选中1个分类时重命名按钮可用
- [ ] 选中0个或多个分类时重命名按钮禁用
- [ ] 勾选分类时删除按钮可用
- [ ] 未勾选分类时删除按钮禁用
- [ ] 新建按钮始终可用（浏览模式）

## 反馈

如果发现任何问题，请记录：
1. 问题描述
2. 重现步骤
3. 预期行为
4. 实际行为
5. 错误信息（如果有）
